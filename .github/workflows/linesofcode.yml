name: Count Lines of Code for Sprint

on:
  workflow_dispatch:
    inputs:
      since:
        description: 'Sprint start date (YYYY-MM-DD) or commit/tag'
        required: true
      until:
        description: 'Sprint end date (YYYY-MM-DD, optional)'
        required: false
  push:
    branches:
      - main

jobs:
  count-lines:
    runs-on: ubuntu-latest
    if: github.actor != '' # All authenticated actors; branch protection/CODEOWNERS handles commit access
    steps:
      - uses: actions/checkout@v4

      - name: Install cloc
        run: sudo apt-get update && sudo apt-get install -y cloc git

      - name: Calculate line count delta for sprint
        id: sprint_lines
        run: |
          # Get commit hashes for the sprint range (if using date, get the first commit since 'since')
          SINCE="${{ github.event.inputs.since }}"
          UNTIL="${{ github.event.inputs.until }}"
          if [[ -z "$SINCE" ]]; then
            echo "Must specify input 'since' (start date or tag/commit)"; exit 1
          fi

          # If date, find commit hashes
          if [[ "$SINCE" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
            since_commit=$(git rev-list --after="$SINCE" --max-parents=0 HEAD | tail -1)
          else
            since_commit=$SINCE
          fi
          if [ -z "$since_commit" ]; then echo "Could not determine start commit"; exit 1; fi

          if [[ -n "$UNTIL" ]]; then
            if [[ "$UNTIL" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              until_commit=$(git rev-list -1 --before="$UNTIL 23:59:59" HEAD)
            else
              until_commit=$UNTIL
            fi
          else
            until_commit=HEAD
          fi

          # Fetch the code at since and until
          git checkout $since_commit
          cloc . --json --out=before.json
          git checkout $until_commit
          cloc . --json --out=after.json

          # Calculate lines added in the period
          before=$(jq '.SUM.code' before.json)
          after=$(jq '.SUM.code' after.json)
          delta=$((after-before))
          echo "Lines of code at start: $before"
          echo "Lines of code at end: $after"
          echo "Lines of code added during sprint: $delta"
          echo "sprint_lines=$delta" >> $GITHUB_ENV

      - name: Output sprint code lines
